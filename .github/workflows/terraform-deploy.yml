name: Terraform Azure Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write # Required if you configure OIDC, otherwise not strictly needed for Client Secret
  contents: read

jobs:
  terraform:
    name: 'Terraform Plan & Apply'
    runs-on: ubuntu-latest
    env:
      # Authentication for Azure using service principal via GitHub Secrets
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      # Working directory pointing to our dev environment
      WORKING_DIR: ./environments/dev

    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Deploy Bootstrap (Storage Backend)
        run: |
          # The GitHub action runner can occasionally break parsing secrets if they contain trailing spaces or invisible characters from a UI copy/paste
          # we sanitize these before passing them to terraform to avoid random 'SubscriptionNotFound' errors
          export ARM_CLIENT_ID=$(echo -n "$ARM_CLIENT_ID" | tr -d '[:space:]"')
          export ARM_CLIENT_SECRET=$(echo -n "$ARM_CLIENT_SECRET" | tr -d '[:space:]"')
          export ARM_SUBSCRIPTION_ID=$(echo -n "$ARM_SUBSCRIPTION_ID" | tr -d '[:space:]"')
          export ARM_TENANT_ID=$(echo -n "$ARM_TENANT_ID" | tr -d '[:space:]"')
          
          # Initialize and apply the bootstrap terraform code locally to create the backend storage
          cd ../bootstrap
          terraform init
          terraform apply -auto-approve
          
          # Tell terraform to output the randomly generated storage account name and save it
          SA_NAME=$(terraform output -raw storage_account_name)
          echo "Determined Storage Account Name: $SA_NAME"
          
          # Navigate back to the main environment and inject the exact storage account name
          cd ../dev
          sed -i "s/storage_account_name = \".*\"/storage_account_name = \"$SA_NAME\"/g" backend.tf

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        run: terraform plan -no-color -input=false

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false
